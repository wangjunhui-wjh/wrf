# 项目进展（WRF 风场超分辨率）
日期：2026-02-01

## 总览
当前仓库已包含：
- WRF HR/LR 预处理流程
- 观测产品（站点 + 雷达 30min）
- 站点/雷达一键评估（指标表 + 过程图 + 散度统计）
- SR 训练/推理流程（Bicubic / ESPCN / U‑Net / PhySR‑Wind）
- 方案一主评估（模型预测 vs WRF‑HR）
- 物理一致性评估（散度 PDF / PSD / 尺度一致性）
- 典型场景可视化（风速场 + 误差分布）
- 新增：静态地形输入支持、残差训练、尺度一致性损失

关键约束：2025‑09 WRF 数据尚未处理完成，训练默认排除，留作最终验证。

## 数据清单（当前）
- `processed_data/hr/` 与 `processed_data/lr/`：月度 zarr（2024‑01 到 2025‑10；2025‑09 不完整，2025‑11 已移除）
- `processed_data/obs/`：
  - `station_30min.csv/.nc`
  - `station_meta.csv`（48 站点坐标）
  - `radar_*_30min.csv/.nc`（DBS 反演，实际高度门约 85m）
  - `radar_*_meta.json`
- `processed_data/pred/`：2025‑10 的四模型预测（bicubic/espcn/unet/physr）
- `processed_data/eval/`：站点/雷达评估 + WRF 基线评估输出
- `processed_data/summary/`：论文汇总表与图（主表、季节/风速分档、物理一致性、case 图）

## 关键变更记录（最近）
- `run_fix_pred_time.py`：修复 pred zarr 时间轴（用 manifest 对齐）
- `run_eval_all.py`：批量评估所有模型
- `run_summarize_eval.py`：汇总评估输出与图
- `run_eval_wrf_baseline.py`：WRF‑HR / WRF‑LR 基线评估（LR 通过 bicubic 对齐）
- `run_grid_metrics.py`：模型预测 vs WRF‑HR 主评估表
- `run_physics_consistency.py`：散度 PDF / PSD / 尺度一致性表
- `run_case_maps.py`：典型场景风速/误差图
- `src/evaluation.py`：Agg 后端、时间对齐 & 去重
- `src/sr_dataset.py`：支持静态地形输入（grid_static + HGT）
- `run_train_sr.py` / `run_infer_sr.py`：支持残差训练与尺度一致性损失

## 当前进度
### 已完成
- 观测产品生成与 QC 检查
- 站点元数据合并（过滤无坐标站点，保留 48 站点）
- 雷达 DBS 反演产品
- 四模型训练与 2025‑10 推理输出
- 站点/雷达评估（2025‑10，四模型）
- WRF‑HR vs 站点基线评估（2025‑10）
- WRF‑LR vs 站点基线评估（通过 bicubic 上采样）
- 方案一主评估（模型预测 vs WRF‑HR）
  - `processed_data/summary/metrics_grid_overall_2025-10.csv`
- 物理一致性结果（2025‑10）
  - `divergence_pdf_2025-10.png`
  - `psd_2025-10.png`
  - `scale_consistency_table_2025-10.csv`
- 典型场景图（风速场 + 误差图）
  - `processed_data/summary/cases/`

### 进行中 / 待处理
- 若要使用地形先验：需在 `grid_static.zarr` 中加入 `HGT`（可重新处理或从原始 WRF 抽取）
- 扩展到更多月份（至少 DJF/MAM/JJA/SON 各 1）
- 2025‑09 数据处理完成后做最终独立验证
- 如需分区评估（城区/农田/湖区），需提供区域掩膜

## 快速流程（建议顺序）
1) 站点/雷达评估（批量）：
   ```bash
   .venv\Scripts\python run_eval_all.py --months 2025-10
   ```

2) 方案一主评估（模型 vs WRF‑HR）：
   ```bash
   .venv\Scripts\python run_grid_metrics.py --month 2025-10 --out processed_data/summary/metrics_grid_overall_2025-10.csv
   ```

3) 物理一致性评估：
   ```bash
   .venv\Scripts\python run_physics_consistency.py --month 2025-10 --samples 20
   ```

4) 典型场景可视化：
   ```bash
   .venv\Scripts\python run_case_maps.py --month 2025-10
   ```

5) WRF 基线（站点）：
   ```bash
   .venv\Scripts\python run_eval_wrf_baseline.py --month 2025-10 --use hr --skip-radar --skip-divergence
   .venv\Scripts\python run_eval_wrf_baseline.py --month 2025-10 --use lr --skip-radar --skip-divergence
   ```

6) 如需启用静态地形 + 残差/尺度损失：
   ```bash
   .venv\Scripts\python run_compute_stats.py --static-vars HGT --grid-static processed_data/grid_static.zarr --out processed_data/stats.json
   .venv\Scripts\python run_train_sr.py --model unet --static-vars HGT --grid-static processed_data/grid_static.zarr --residual --lambda-scale 0.1 --stats processed_data/stats.json
   .venv\Scripts\python run_infer_sr.py --model unet --weights processed_data/checkpoints/unet_x4/best.pt --months 2025-10 --static-vars HGT --grid-static processed_data/grid_static.zarr --residual --stats processed_data/stats.json
   ```

## 环境说明
- RTX 5060 Ti (sm_120) 需要 PyTorch nightly cu128：
  ```bash
  pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu128
  ```
- 若 GPU 安装受阻，可临时使用 CPU：`--device cpu`
